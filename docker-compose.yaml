services:
  ci:
    image: kcov/kcov
    security_opt:
      - seccomp=unconfined
    volumes:
      - .:/source
    working_dir: /source
    environment:
      - HOST_UID=${HOST_UID:-1000}
      - HOST_GID=${HOST_GID:-1000}
    entrypoint: /bin/bash
    command:
      - -c
      - |
        set -e
        apt-get update && \
        apt-get install -y --no-install-recommends \
            bats \
            bats-support \
            bats-assert \
            bats-file \
            shellcheck

        echo "--- Running ShellCheck ---"
        find src -name "*.sh" -o -name "*.bash" | xargs -r shellcheck -x
        find test -name "*.bats" | xargs -r shellcheck -x -s bash

        echo "--- Running Tests & Coverage ---"
        kcov --include-path=./src \
            --exclude-path=test/ \
            ./coverage \
            bats test/

        if [ -n "${HOST_UID}" ] && [ -n "${HOST_GID}" ]; then
            echo "--- Fixing permissions for coverage directory ---"
            chown -R "${HOST_UID}:${HOST_GID}" coverage/
            echo "Coverage report generated at: $(pwd)/coverage/index.html"
        fi
